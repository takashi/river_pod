---
title: プロバイダ
---

[Riverpod] をインストールしたところで、"プロバイダ" について話しましょう。

プロバイダは [Riverpod] アプリケーションにおいて最も重要な部分を担っています。
プロバイダは状態の一部をカプセル化し、その状態の購読を可能にするオブジェクトです。

## なぜプロバイダを使うのか？

状態の一部をプロバイダでラップすることによって:

- 複数の場所でその状態に簡単にアクセスできるようになります。
  Service Locators、Dependency Injection、InheritedWidgets などのパターンを完全に置き換えるものです。

- 状態同士を組み合わせることを簡単にします。
  複数のオブジェクトを 1 つにまとめるのに苦労したことはありませんか？
  プロバイダを使えば簡単な構文でこれを解決できます。

- パフォーマンスを最適化できます。
  どうにかしてウィジェットの再構築をフィルタリングしたり、時間のかかる状態の演算をキャッシュする代わりに、
  プロバイダは、状態の変化によって影響を受けるものだけが再計算されることを保証します。

- テスタビリティを向上させます。
  プロバイダを使えば、複雑な `setUp`/`tearDown` は必要ありません。
  さらに、どのプロバイダもテスト時に異なる動作をするようにオーバーライドすることができるので、特定の動作を簡単にテストすることができます。

- ロギングや pull-to-refresh のような高度な機能と簡単に統合できます。

## プロバイダを作成する

プロバイダにはさまざまな種類がありますが、どれも仕組みは同じです。

もっとも一般的な利用方法は、プロバイダをグローバル定数として定義することです:

```dart
final myProvider = Provider((ref) {
  return MyValue();
});
```

:::note
プロバイダのグローバルな側面を恐れる必要はありません。
プロバイダはイミュータブルです。プロバイダを宣言することは関数を宣言することとなんら変わらず、テスタブルでメンテナンス可能です。
:::

このスニペットは 3 つの要素から構成されています:

- `final myProvider` 変数の宣言です。
  この変数は、将来的にプロバイダの状態を読み取るために使用されます。
  これは常にイミュータブルであるべきです。

- `Provider` 今回使用することにきめたプロバイダです。
  [Provider] はすべてのプロバイダの中で最も基本的なもので、決して変わることのないオブジェクトを公開します。
  [Provider] を別のプロバイダ、例えば [StreamProvider] や [StateNotifierProvider] と置き換えることで値の操作方法を変更することができます。

- 共有する状態を作成する関数。
  この関数は、常にパラメータとして `ref` というオブジェクトを受け取ります。
  このオブジェクトは、他のプロバイダを読み込んだり、自分のプロバイダの状態が破棄されるときに何らかの操作を行うことができます。

プロバイダに渡された関数が作成すべきオブジェクトの種類は、どのプロバイダを利用するかに依存します。
例えば [Provider] に渡す関数はどんなオブジェクトでも作成できます。
一方で [StreamProvider] のコールバックは [Stream] を返すことを期待されます。

:::info
プロバイダは制限なく、好きなだけ宣言することができます。
[Riverpod] では `package:provider` を利用するときとは対象的に、同じ "type" を持つプロバイダを 2 つ公開することができます。

```dart
final cityProvider = Provider((ref) => 'London');
final countryProvider = Provider((ref) => 'England');
```

どちらのプロバイダも `String` を作成しますが、これに何の問題もありません。
:::

:::caution
プロバイダを動作させるために、`ProviderScope` を Flutter アプリケーションのルートに追加する必要があります。

```dart
void main() {
  runApp(ProviderScope(child: MyApp()));
}
```

:::

## 状態が破壊される前に処理を行う

場合によっては、プロバイダの状態が破壊されたり、再作成されたりすることもあります。

In some cases, the state of a provider may get destroyed or re-created.
一般的な使用例は、プロバイダの状態が破壊される前にクリーンアップを実行することです。
例えば、`StreamController`を close するなどです。

これはすべてのプロバイダのコールバックに渡される `ref` オブジェクトの、`onDispose` メソッドによって行われます。

次の例では [onDispose] を使って `StreamController` を close しています:

```dart
final example = StreamProvider.autoDispose((ref) {
  final streamController = StreamController<int>();

  ref.onDispose(() {
    // Closes the StreamController when the state of this provider is destroyed.
    streamController.close();
  });

  return streamController.stream;
});
```

:::note
利用するプロバイダによっては、すでにクリーンアップの処理を行っているものもあります。
例えば、[StateNotifierProvider] は `StateNotifier` の `dispose` メソッドを呼び出しています。
:::

## プロバイダ修飾子

すべてのプロバイダは、宣言時に機能を追加できる方法をビルトインで提供しています。

それらは `ref` オブジェクトに対して新しい機能を追加したり、プロバイダがどのように消費されるかを少し変更したりします。
プロバイダ修飾子はすべてのプロバイダで、かつ名前付きコンストラクタに似た文法で使用することができます:

```dart
final myAutoDisposeProvider = StateProvider.autoDispose<String>((ref) => 0);
final myFamilyProvider = Provider.family<String, int>((ref, id) => '$id');
```

現時点では、2 つの修飾子が利用可能です:

- [`.autoDispose`](/docs/concepts/modifiers/auto_dispose) はプロバイダを、そのステートがもう購読されていない場合に、そのステートを破棄するように変更します。
- [`.family`](/docs/concepts/modifiers/family) はプロバイダを外部の引数とともに作成できるようにします。

:::note
プロバイダは一度に複数の修飾子を利用することができます:

```dart
final userProvider = FutureProvider.autoDispose.family<User, int>((ref, userId) async {
  return fetchUser(userId);
});
```

:::

今回のガイドはここまでです！

[How to read a provider](/docs/concepts/reading) を続けてお読みいただけます。
または [How to combine providers](/docs/concepts/combining_providers) をご覧ください。

[get_it]: http://pub.dev/packages/get_it
[inheritedwidget]: https://api.flutter.dev/flutter/widgets/InheritedWidget-class.html
[stream]: https://api.dart.dev/stable/2.8.4/dart-async/Stream-class.html
[ondispose]: https://pub.dev/documentation/riverpod/latest/riverpod/ProviderRefBase/onDispose.html
[riverpod]: https://github.com/rrousselgit/river_pod
[hooks_riverpod]: https://pub.dev/packages/hooks_riverpod
[flutter_riverpod]: https://pub.dev/packages/flutter_riverpod
[flutter_hooks]: https://github.com/rrousselGit/flutter_hooks
[provider]: https://pub.dev/documentation/riverpod/latest/riverpod/Provider-class.html
[streamprovider]: https://pub.dev/documentation/riverpod/latest/riverpod/StreamProvider-class.html
[statenotifierprovider]: https://pub.dev/documentation/riverpod/latest/riverpod/StateNotifierProvider-class.html
[providerscope]: https://pub.dev/documentation/flutter_riverpod/latest/flutter_riverpod/ProviderScope-class.html
